"use strict";

var net = require("net");

net.Socket.prototype.readForever = function(handler){
	var recvBuffer = new Buffer(0);
	var begin = 0;
	this.on("data", chunk => {
		recvBuffer = Buffer.concat([recvBuffer, chunk]);
		var end = recvBuffer.length;
		for(;;){
			if(end - begin < 2)
				break;
			var packetLen = recvBuffer.readUInt16BE(begin);
			if(end - begin < packetLen)
				break;
			handler(this, recvBuffer.slice(begin, begin+packetLen));
			begin += packetLen;
		}
		if(begin > 0){
			recvBuffer = recvBuffer.slice(begin);
			begin = 0;
		}
	});
};