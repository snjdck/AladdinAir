"use strict";

const Socket = require("net").Socket;

Socket.prototype.readForever = function(handler){
	var recvBuffer = new Buffer(0);
	var begin = 0;
	this.on("data", chunk => {
		recvBuffer = Buffer.concat([recvBuffer, chunk], recvBuffer.length + chunk.length);
		const end = recvBuffer.length;
		for(;;){
			if(end - begin < 2)
				break;
			const packetLen = recvBuffer.readUInt16BE(begin);
			if(packetLen < 2){
				this.destroy();
				return;
			}
			if(end - begin < packetLen)
				break;
			handler(this, recvBuffer.slice(begin, begin+packetLen));
			begin += packetLen;
		}
		if(begin > 0){
			recvBuffer = recvBuffer.slice(begin);
			begin = 0;
		}
	});
};

Socket.prototype.listenCloseEvent = function(timeout, handler){
	const onClose = () => {
		this.removeAllListeners();
		if(handler != null)
			handler(this);
	};
	this.on("close",  onClose);
	this.on("error",  onClose);
	this.on("timeout",onClose);
	this.setTimeout(timeout);
};